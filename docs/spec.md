
## 技術スタック

- 開発言語はdart
- フレームワークはflutter
- ユーザーがスーパーの店内で片手で操作することを想定し、**Flutter**を基盤とした「オフラインファースト」な設計を採用します。また、レシピ閲覧時の体験を向上させる独自のオーバーレイ機能を備えます。
- **UIフレームワークと状態管理**
  - **Flutter**を採用し、iOS/Android両対応の高速な開発を実現します。複雑な在庫ステータス（買う・カゴ・在庫など）の遷移は**Riverpod**で一元管理し、どの画面からでも最新の在庫状況が即座に反映されるようにします。
  - **オフライン動作とローカルDB**
    - 電波の入りにくいスーパー内での利用を考慮し、**Isar**（高速なNoSQLローカルDB）を導入します。買い物リストのチェック操作やステータス変更はまずローカルで完結させ、通信圏内に入った際に自動でバックエンドのFirestoreと同期する仕組みを構築します。
- アーキテクチャはレイヤードアーキテクチャで構成してください

## 画面仕様

画面のデザインは @design\stitch_ingredient_sorting_screen/ 以下にある code.html ファイルを参考にしてください。

### 色情報

カラーテーマ

```dart
class AppColors {
  static const stoxPrimary = Colors.black;
  static const stoxBackground = Colors.white;
  static const stoxAccent = Color(0xFFFF007F); // Vivid Pink
  static const stoxText = Color(0xFF1C160D); // Keep for now, or use Colors.black
  static const stoxBorder = Color(0xFFE0E0E0); // Changed to Grey to fit monochrome theme
  static const stoxCardBg = Colors.white;
  static const stoxDarkCardBg = Color(0xFF1E1E1E); // Darker grey for dark mode potential
  static const stoxSubText = Color(0xFF757575); // Grey for subtext
  static const stoxBannerBg = Color(0xFFF5F5F5); // Light grey instead of orange tint
  static const stoxGreen = Color(0xFF7FB069);
}
```

「AIに提案してもらう」などAIを利用するアクションの起点となるボタンにはピンクのグラデーションのボーダーのボタンを使う

### ホーム画面

- ホーム画面
  - これから作る献立
  - 買うもの
  - 賞味期限が近そうなもの
  - 保有ポイント
  - 広告権利数
  - 料理作り終わった？
    - マイレシピ帳からお料理モードにして、is_doneになっていない献立があったら、「料理作り終わった？」の表示を出す
    - リンク先は、献立
- ポイント
  - 持っているポイントを表示する
  - ポイント交換ができる
- 広告
  - 広告権利数分の広告を見ることができる
  - 広告を見るとポイントがもらえる
  - 広告権利数は減らない
    - 毎日◯時で権利がなくなる、みたいな仕様にはしない
    - 手が空いたときに広告を一気に見てポイントをゲットできるようにする
    - Wi-Fiがあるときだけ見れるようにする設定を追加する
    - 「連続再生は5回まで。10分休むとまた見れる」といった緩い制限を入れることで、アカウントの安全性を守れます。
- 設定
  - 広告の再生をWi-Fi環境だけにする

### チラシ

- 近所のスーパーのチラシ
  - GPSで近所のスーパーのチラシ一覧が見れる
  - （可能であれば）ステータスが「買うもの」のリストから、安いスーパーを確定して、どのお店でどの商品を買うか、提案してくれる
  - 提案: 「合計金額が一番安い店」だけでなく、「1店舗で全部揃う中での最安値」を提案できると、タイパ（タイムパフォーマンス）を重視するユーザーに刺さります。

### お買い物

- お買い物
  - ステータスが「買うもの」になっている材料の一覧を表示する
  - お買い物モードONをタップすると以下の状態になる
    - 画面がスリープにならない
    - ボトムメニューを非表示にする
  - 画面のどこかに「買い物しゅーりょー」ボタンを表示する
- レシート撮影
  - 買い物が終わってレシートを撮影すると、「かごに入れた」ステータスの材料を「在庫」に更新する
  - 広告権利数インクリメント

### 在庫

- 在庫
  - 「買うもの」「在庫」のすべての材料を一覧で表示する
  - デフォルトは賞味期限が近いものを上に表示する
  - 種別ごとに一覧にできる

### マイレシピ帳

#### マイレシピ帳トップ
- レシピを検索する入力フォーム
- これから作る献立の、グループ化されたレシピページのOGP画像
- 今までに作った献立一覧
#### これから作る献立画面
- 複数のレシピページを、上部のタブで切り替える
  - タブを切り替えたら、それぞれのレシピページが表示される
  - （可能であれば）レシピページのスクロールの位置は、タブを切り替えても前回開いたときの状態をキープする
- タブの上、「献立」のタイトルの横にある「お料理モードON」ボタンをタップすると、「お料理モード」になり、以下の設定になる
  - スリープにならない
  - ボトムメニューを非表示にする
  - フローティングタイマーを表示する
- 画面のどこかに、「作り終わった」ボタンを用意する
  - 作り終わったらデータベースの is_done をtrueにする
  - レシピに関連している材料が減っているはずなので、在庫の更新をする画面を表示する
    - 材料ごとに「無くなったから買う」「無くなったけど買わない」」「まだあるから買わない」「まだあるけど買う」を選択できるようにする
      - 「無くなったから買う」「まだあるけど買う」を選択したものは、材料ステータスを「買う」にする
  - 広告権利数インクリメント
#### レシピ検索結果
- URLが入力された場合は、直接webviewを表示するので、この画面は経由しない
- 入力フォームに入力した文字がURLではない場合は、検索APIの結果を表示する
  - 結果をタップしたら、そのページをwebviewで開く
  - webviewの右下に「このレシピを作る」ボタンをフローティングする
    - 「このレシピを作る」ボタンをタップすると、「材料を解析する」「献立に追加する」「何もしない」の選択肢が表示される
    - 「何もしない」をタップすると、そのモーダルを閉じる
    - 「献立に追加する」をタップすると、今日から６日後までの日付と曜日が表示されて、その下に「朝」「夜」など「いつ用？」の選択肢が表示される
      - 選択した日付と「いつ用？」をデータベースに登録して、そのモーダルを閉じる
      - 献立に登録するのは、レシピサイトのレシピページのOGP画像とタイトルを設定する
      - 広告権利数インクリメント
    - 「材料を解析する」をタップすると、材料を解析して、解析した材料一覧画面に遷移する（すでに存在するので、画面イメージは不要）
      - 人数分の計算ができる
        - レシピページでは2人分で、実際には3人分作りたいときに、人数分の分量に計算しなおす。
        - ただ機械的に解析して分量を増やすと「2人分を4人分にすると8分の1の分量が16分の2になった」みたいなことがあり得るし、単純に増やしたり減らしたりするだけだと味が変わってしまう料理があるのを注意する
          - https://news.cookpad.com/articles/59456
          - なので、計算するときはAIに質問して、回答を表示する
      - 在庫の材料にあるものは「ある」が選択されている状態になる
      - 広告権利数インクリメント
#### 献立計画表
- 今週１週間の日付と曜日を日曜始まり土曜終わりで１列に表示する。
  - このエリアをスワイプすると、先週、来週の日付が表示される
  - 画面の右上にカレンダーアイコンを表示して、カレンダーから週を選べるようにする
- 日付を選んだら、いつ用（朝、昼、夜、夕方、作り置き、おやつ、おつまみ）ごとにグループ化されたレシピを画面上に表示する

## サーバーAPI設計

- 材料（商品）名寄せ
  - 手入力、またはレシピページから抽出した材料名を、概念を集約した一つの名前に変換するAPI
  - 「にんじん」「人参」を「にんじん」に統一する
  - 名前のリストを受け取って、マッピングで返す
  - 材料マスターも返す
    - 材料名
    - 名寄せ前
    - is_essential
      - 買い物リストのノイズを減らすためのフィルター
        - レシピを解析すると、「塩」「胡椒」「サラダ油」「醤油」などの基本調味料も材料として抽出されます。 もしこのフラグがないと、レシピを「献立」に追加するたびに、アプリはこう動いてしまいます。
      - is_essential = True のもの： レシピに含まれていても、デフォルトでは買い物リストに入れない。（「基本家にあるもの」として扱う）
      - is_essential = False のもの： 「鶏肉」「人参」など、無ければ買わないといけないもの。
    - storage_type
      - 保存場所（冷蔵、冷凍、常温）。「在庫一覧」でこれがあると、探すのが格段に楽になります。
- 賞味期限
  - 材料（商品）ごとに、購入日から何日間日持ちするかを返す
  - 名前のリストを受け取って、マッピングで返す
- カテゴリ振り分け
  - 材料（商品）のカテゴリをマッピングで返す

## データベース設計

- レシピ
  - ID
  - レシピタイトル
  - レシピページURL
  - レシピページOGP画像URL
  - 最初に保存した日時
  - 作った回数
  - 基本の人数 (default_servings)
  - レーティング (星1から5、また作りたい度合い)
  - 最終調理日
  - is_deleted
    - レシピを削除しても cooked_count などの統計データは残しておきたい場合があるため、物理削除ではなく論理削除
- レシピタグ
  - レシピID
  - タグ文字列
- 献立計画
  - レシピID
  - 日付
  - いつ用？（朝、夜、など文字列で持つか列挙型にするか）
  - is_done (実際に作ったかどうかのフラグ)
- レシピメモ
  - レシピID
  - メモ
- 材料
  - ID
  - 材料名
  - standard_name (名寄せ用：例「人参」「にんじん」を同じものとして扱うため)
  - カテゴリ (野菜、肉、など)
  - unit
  - 登録日時
  - 更新日時
- 材料ステータス(材料IDとステータスでインデックス)
  - 材料ID
  - ステータス(buying(買う), in_cart(かご), stock(在庫))
  - 量
- レシピ材料
  - レシピID
  - 材料ID
  - 量
- 賞味期限 (MaterialExpiries)
  - ID
  - 材料ID
  - purchase_date	購入日
  - expiry_date	API結果から算出された仮の期限日
  - is_confirmed	ユーザーが手動で期限を修正したかどうかのフラグ
  - consumed_at	使い切った日時（nullなら在庫あり）
- ユーザー
  - ID
  - 広告権利数
  - ポイント
  - 設定関連
- 広告履歴 (AdLogs)
  - user_id
  - action_type (レシピ登録、レシート撮影など)
  - 作成日時